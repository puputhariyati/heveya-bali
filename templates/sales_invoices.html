{% extends 'base.html' %}

{% block title %}Sales Order{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='sales_order.css') }}">
{% endblock %}

{% block content %}
    <div class="main-content">
        <div class="top-bar">
            <select id="status" onchange="filterOrders()">
                <option value="">All</option>
                <option value="open">Open</option>
                <option value="partially sent">Partially Sent</option>
                <option value="closed">Closed</option>
            </select>
            <input type="text" id="searchBox" placeholder="Search Customer / Order No" oninput="filterOrders()" />
            <div class="tabs">
                <button onclick="showCalendarView()">ETD Calendar</button>
            </div>
            <div id="delivery-calendar" style="display:none;"></div>
            <div class="date-filter">
              <label>From: <input type="date" id="startDate" onchange="filterByDateRange()" /></label>
              <label>To: <input type="date" id="endDate" onchange="filterByDateRange()" /></label>
            </div>
        </div>

        <div style="text-align: center">
            <p>Bulk Edit : </p>
            <button onclick="bulkUpdateStatus('closed')">Close Orders</button>
            <input type="date" id="bulk-etd" />
            <button onclick="bulkUpdateETD()">Set ETD</button>
        </div>

        <!-- Calendar Modal -->
        <div id="calendarModal" class="calendar-modal">
          <div class="calendar-content">
            <span class="close-btn" onclick="closeCalendar()">&times;</span>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <button onclick="prevMonth()">â—€</button>
              <div>
                <select id="calendarMonth" onchange="buildCalendar()">
                  <!-- months will be inserted by JS -->
                </select>
                <select id="calendarYear" onchange="buildCalendar()">
                  <!-- years will be inserted by JS -->
                </select>
              </div>
              <button onclick="nextMonth()">â–¶</button>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
          </div>
        </div>

        <button id="btnRefresh">ðŸ”„ Refresh orders</button>
        <span id="lastRefresh" style="margin-left:1rem;color:#666;"></span>

        <!-- Sales Order Table -->
        <div id="delivery-table">
          <h2>Sales Orders</h2>
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" onclick="toggleAll(this)"></th>
                  <th>Date</th>
                  <th>Order No</th>
                  <th>Customer</th>
                  <th>Balance Due</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>ETD</th>
                </tr>
              </thead>
              <tbody>
                {% for order in orders %}
                <tr>
                    <td><input type="checkbox" class="row-check"></td>
                    <td>{{ order.transaction_date }}</td>
                    <td><a href="/sales_invoices/{{ order.transaction_no }}">{{ order.transaction_no }}</a></td>
                    <td>{{ order.customer or '-' }}</td>
                    <td>{{ order.balance_due or '-' }}</td>
                    <td>{{ order.total or '-' }}</td>
                    <td>{{ order.status.capitalize() }}</td>
                    <td><input type="date" name="ETD" value="{{ order.ETD }}"></td>
                </tr>
                {% endfor %}
              </tbody>

            </table>
            <!-- â–¸â–¸ Pagination controls  --------------------------------- -->
            <div class="pagination-container">
              <div class="pagination-left">
                <label>
                  Rows per page
                  <select id="rowsPerPage" onchange="changeRowsPerPage(this.value)">
                    <option>5</option><option>10</option><option selected>25</option>
                    <option>50</option><option>100</option>
                  </select>
                </label>
                <span id="pageInfo"></span>
              </div>
              <div class="pagination-right">
                <button onclick="prevPage()">â—€</button>
                <input type="number" id="pageInput" min="1" value="1"
                       onchange="goToPage(this.value)">
                <span id="totalPages"></span>
                <button onclick="nextPage()">â–¶</button>
              </div>
            </div>
            <!-- --------------------------------------------------------- -->

            <br>
          </form>
        </div>
    </div>

    <script>
      const salesOrders = {{ orders | tojson }};
    </script>
    <script src="{{ url_for('static', filename='sales_order.js') }}"></script>


{% endblock %}
